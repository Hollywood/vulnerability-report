'use strict'
let { graphql } = require("@octokit/graphql")

module.exports = async function exportVulnerabilityList (after) {

    graphql = graphql.defaults({
        method: 'POST',
        headers: {
            authorization: `token ${process.env.GITHUB_TOKEN}`,
        },
    });

    const query = ` query($after: String) {
        securityAdvisories(orderBy: {field: PUBLISHED_AT, direction: DESC}, first: 100, after: $after) 
        {
            nodes {
                ghsaId
                publishedAt
                description
                summary
            }
            pageInfo {
                hasNextPage
                endCursor
            }
        }
    }
  `

  const securityVulnerabilities = []

  async function getVulnerabilities (after) {
    const result = await graphql(query, { after })
    const {nodes, pageInfo } = result.securityAdvisories
    
    nodes.forEach(node => {
        securityVulnerabilities.push(node)
    });
    
    if (pageInfo.hasNextPage) {
        return getVulnerabilities(pageInfo.endCursor)
    } 

    return securityVulnerabilities
  }
    
  return getVulnerabilities()
}